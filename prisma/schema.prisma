generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  TEACHER
  STUDENT
}

enum QuestionType {
  MULTIPLE_CHOICE
  OPEN_ENDED
}

enum CertificateGrade {
  A_PLUS
  A
  B_PLUS
  B
  C_PLUS
  C
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  role      Role     @default(STUDENT)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  studentProfile StudentProfile?
  teacherProfile TeacherProfile?
  conversations  Conversation[]
  testAttempts   TestAttempt[]
}

model AIConfig {
  id        String   @id @default(cuid())
  modelName String   @default("deepseek-chat")
  apiKey    String
  baseUrl   String   @default("https://api.deepseek.com")
  maxTokens Int      @default(2048)
  updatedAt DateTime @updatedAt
}

model Subject {
  id   String @id @default(cuid())
  name String
  slug String @unique

  studentProfiles StudentProfile[]
  tests           Test[]
  ragDocuments    RAGDocument[]
}

model StudentProfile {
  id            String           @id @default(cuid())
  userId        String           @unique
  subjectId     String
  currentLevel  String
  targetGrade   CertificateGrade
  availableDays Int
  hoursPerDay   Int
  abilityLevel  Float            @default(0.0) // Rasch model student ability (logits)
  createdAt     DateTime         @default(now())

  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  subject    Subject     @relation(fields: [subjectId], references: [id])
  weakTopics WeakTopic[]
}

model WeakTopic {
  id           String   @id @default(cuid())
  studentId    String
  topic        String
  mistakeCount Int      @default(1)
  lastSeen     DateTime @default(now())

  student StudentProfile @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, topic])
}

model Conversation {
  id        String   @id @default(cuid())
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages Message[]
}

model Message {
  id             String   @id @default(cuid())
  conversationId String
  role           String
  content        String   @db.Text
  createdAt      DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
}

model TeacherProfile {
  id     String @id @default(cuid())
  userId String @unique

  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tests Test[]
}

model Test {
  id          String   @id @default(cuid())
  teacherId   String
  subjectId   String
  title       String
  description String?  @db.Text
  isPublic    Boolean  @default(false)
  shareLink   String   @unique @default(cuid())
  timeLimit   Int      @default(30)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  teacher   TeacherProfile @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  subject   Subject        @relation(fields: [subjectId], references: [id])
  questions TestQuestion[]
  attempts  TestAttempt[]
}

model TestQuestion {
  id              String       @id @default(cuid())
  testId          String
  type            QuestionType @default(MULTIPLE_CHOICE)
  questionText    String       @db.Text
  options         Json?
  correctAnswer   String
  topic           String?
  orderIndex      Int          @default(0)
  difficulty      Float        @default(0.0) // Rasch model item difficulty (logits)
  attemptCount    Int          @default(0)   // Total times answered
  correctCount    Int          @default(0)   // Times answered correctly 

  test Test @relation(fields: [testId], references: [id], onDelete: Cascade)
}

model TestAttempt {
  id         String    @id @default(cuid())
  testId     String
  userId     String
  answers    Json
  score      Float?
  startedAt  DateTime  @default(now())
  finishedAt DateTime?
  analyzed   Boolean   @default(false)

  test Test @relation(fields: [testId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model RAGDocument {
  id         String   @id @default(cuid())
  title      String
  content    String   @db.Text
  subjectId  String
  sourceType String   @default("manual")
  uploadedAt DateTime @default(now())

  subject Subject @relation(fields: [subjectId], references: [id])
}
